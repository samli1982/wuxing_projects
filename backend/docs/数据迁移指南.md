# 命盘管理系统数据迁移指南

## 📋 概述

本指南说明如何将会员和命盘数据从小程序迁移到后台管理系统的数据库中。

## 🔄 迁移流程

### 阶段1：测试数据导入

如果想快速验证系统功能，可以导入测试数据：

```bash
# 进入后端项目目录
cd /Users/saml/GoProjects/src/wuxing_projects/backend

# 使用 MySQL 客户端执行迁移脚本
mysql -h localhost -u root -p < sql/migration_data.sql
```

**测试数据包括：**
- 5个示例会员（张三、李四、王五、赵六、孙七）
- 6个示例命盘（分属不同会员）
- 3条命盘详情数据（包括八字、五行等信息）

### 阶段2：真实数据迁移

#### 方案A：从小程序导出数据（推荐）

1. **导出小程序本地数据**
   ```javascript
   // 在小程序开发者工具的控制台运行以下代码
   wx.getStorage({
     key: 'memberInfo',
     success(res) {
       console.log('会员信息:', res.data)
       // 导出为JSON格式
     }
   })
   
   wx.getStorage({
     key: 'palmtrees',
     success(res) {
       console.log('命盘列表:', res.data)
       // 导出为JSON格式
     }
   })
   ```

2. **转换为SQL语句**
   ```javascript
   // 示例转换脚本
   const memberInfo = {...} // 从小程序导出
   const palmtrees = [...] // 从小程序导出
   
   // 生成INSERT语句
   const insertSQL = `
     INSERT INTO member_user (
       openid, unionid, nickname, avatar, gender, status, member_level
     ) VALUES (
       '${memberInfo.openid}',
       '${memberInfo.unionid}',
       '${memberInfo.nickname}',
       '${memberInfo.avatarUrl}',
       ${memberInfo.gender || 0},
       1,
       1
     );
   `
   ```

3. **执行SQL导入**
   ```bash
   mysql -h localhost -u root -p wuxing_db < migration.sql
   ```

#### 方案B：通过后台管理系统API创建（推荐生产环境）

1. **登录后台管理系统**
   - 访问：http://localhost:5173
   - 账号：admin
   - 密码：admin123

2. **进入"会员管理"页面**
   - 点击侧边菜单："系统管理" → "会员管理"

3. **手动创建或批量导入会员**
   - 后台管理系统暂不支持批量导入（可后续扩展）
   - 可通过编写脚本调用 API 批量创建

4. **进入"命盘管理"页面**
   - 点击侧边菜单："命盘管理"
   - 选择会员后可查看其所有命盘
   - 支持新增、编辑、删除操作

## 📊 数据对应关系

### 会员数据映射

| 小程序字段 | 后台数据库字段 | 说明 |
|-----------|--------------|------|
| openid | openid | 微信唯一标识 |
| unionid | unionid | 微信联合标识（如有） |
| nickName | nickname | 昵称 |
| avatarUrl | avatar | 头像URL |
| gender | gender | 性别（0未知 1男 2女） |
| - | status | 状态（后台新增，默认1启用） |
| - | member_level | 会员等级（后台新增，默认1普通会员） |

### 命盘数据映射

| 小程序字段 | 后台数据库字段 | 说明 |
|-----------|--------------|------|
| palmtree_id | id | 命盘唯一ID |
| member_id | member_id | 关联会员ID |
| nickname | nickname | 命盘昵称 |
| birth_year | birth_year | 出生年 |
| birth_month | birth_month | 出生月 |
| birth_day | birth_day | 出生日 |
| birth_hour | birth_hour_index | 出生时辰（0-12索引） |
| gender | gender | 性别 |
| - | status | 状态（后台新增，默认1启用） |

## 🛠️ 迁移工具脚本

### Node.js 迁移脚本示例

```javascript
const mysql = require('mysql2/promise');

async function migrateData() {
  const connection = await mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: 'password',
    database: 'wuxing_db'
  });

  try {
    // 1. 获取小程序数据（模拟）
    const memberData = {
      openid: 'openid_xxx',
      unionid: 'unionid_xxx',
      nickname: '用户昵称',
      avatarUrl: 'http://example.com/avatar.jpg',
      gender: 1
    };

    // 2. 插入会员数据
    const [result] = await connection.execute(
      'INSERT INTO member_user (openid, unionid, nickname, avatar, gender, status, member_level) VALUES (?, ?, ?, ?, ?, 1, 1)',
      [
        memberData.openid,
        memberData.unionid,
        memberData.nickname,
        memberData.avatarUrl,
        memberData.gender
      ]
    );

    const memberId = result.insertId;
    console.log(`✅ 会员创建成功，ID: ${memberId}`);

    // 3. 插入命盘数据
    const palmtreeData = {
      nickname: '我的命盘',
      birth_year: 1990,
      birth_month: 5,
      birth_day: 15,
      birth_hour_index: 2,
      gender: 'male'
    };

    const [palmtreeResult] = await connection.execute(
      'INSERT INTO palmtree (member_id, nickname, birth_year, birth_month, birth_day, birth_hour_index, gender, status) VALUES (?, ?, ?, ?, ?, ?, ?, 1)',
      [
        memberId,
        palmtreeData.nickname,
        palmtreeData.birth_year,
        palmtreeData.birth_month,
        palmtreeData.birth_day,
        palmtreeData.birth_hour_index,
        palmtreeData.gender
      ]
    );

    console.log(`✅ 命盘创建成功，ID: ${palmtreeResult.insertId}`);

  } finally {
    await connection.end();
  }
}

migrateData().catch(console.error);
```

## ✅ 验证迁移结果

### SQL查询验证

```sql
-- 查看会员总数
SELECT COUNT(*) as 会员总数 FROM member_user WHERE deleted = 0;

-- 查看命盘总数
SELECT COUNT(*) as 命盘总数 FROM palmtree WHERE deleted = 0;

-- 查看会员及其命盘数量
SELECT 
  mu.id, mu.nickname, COUNT(p.id) as 命盘数量
FROM member_user mu
LEFT JOIN palmtree p ON mu.id = p.member_id AND p.deleted = 0
WHERE mu.deleted = 0
GROUP BY mu.id, mu.nickname
ORDER BY mu.create_time DESC;

-- 查看命盘详情数据
SELECT COUNT(*) as 命盘详情总数 FROM palmtree_detail WHERE deleted = 0;
```

### 前端验证

1. **后台管理系统验证**
   ```
   - 进入"会员管理" → 验证会员列表显示正确
   - 进入"命盘管理" → 选择会员 → 验证命盘列表显示正确
   - 点击"查看详情" → 验证命盘详情数据完整
   ```

2. **小程序验证（如需同步）
   ```
   - 进入"我的" → "我的命盘" → 验证数据是否同步
   - 查看命盘详情 → 验证八字、五行等信息完整
   ```

## ⚙️ 配置检查清单

### 后端配置

- [x] 数据库表结构完整（schema.sql）
- [x] 权限系统配置完整（data.sql）
- [x] 会员API接口完整（MemberController）
- [x] 命盘API接口完整（PalmtreeController）
- [ ] 命盘详情API接口（可选扩展）

### 前端配置

- [x] 会员管理页面（/views/member/index.vue）
- [x] 命盘管理列表页面（/views/palmtree/index.vue）
- [x] 命盘管理详情页面（/views/palmtree/detail.vue）
- [x] 路由配置完整（router/index.js）
- [x] 菜单权限配置完整（config/menu.js）
- [x] API模块完整（api/member.js, api/palmtree.js）

## 🔒 数据安全建议

1. **备份原始数据**
   ```bash
   # 导出小程序数据到文件
   mysql -h localhost -u root -p wuxing_db -e "SELECT * FROM member_user;" > member_backup.sql
   mysql -h localhost -u root -p wuxing_db -e "SELECT * FROM palmtree;" > palmtree_backup.sql
   ```

2. **逐步迁移**
   - 先迁移测试数据验证流程
   - 再迁移小部分真实数据进行功能测试
   - 最后再进行全量迁移

3. **回滚方案**
   - 保留迁移前的备份数据
   - 记录迁移时间戳
   - 必要时可以恢复历史数据

## 📞 常见问题

### Q: 迁移后会员无法登录？
A: 
- 检查 openid 是否一致
- 确认会员状态（status）是否为1（启用）
- 查看后端日志是否有错误提示

### Q: 命盘数据无法关联到会员？
A: 
- 确认 member_id 正确
- 检查会员ID是否存在
- 验证命盘表中的 member_id 外键约束

### Q: 如何删除测试数据？
A: 
```sql
-- 删除会员（级联删除相关命盘）
DELETE FROM palmtree_detail WHERE palmtree_id IN (
  SELECT id FROM palmtree WHERE member_id = 1
);
DELETE FROM palmtree WHERE member_id = 1;
DELETE FROM member_user WHERE id = 1;
```

## 📝 后续计划

1. **开发数据导出功能**
   - 支持从后台导出会员数据
   - 支持导出命盘报告

2. **开发数据导入功能**
   - 支持批量上传会员数据
   - 支持Excel导入

3. **数据同步功能**
   - 小程序数据与后台数据自动同步
   - 解决离线数据冲突问题

4. **数据分析功能**
   - 会员统计分析
   - 命盘数据统计
   - 会员画像分析
