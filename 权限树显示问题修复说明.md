# æƒé™æ ‘æ˜¾ç¤ºé—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

åœ¨è§’è‰²ç®¡ç†çš„"åˆ†é…æƒé™"å¯¹è¯æ¡†ä¸­ï¼Œæƒé™æ ‘åªæ˜¾ç¤º"ç³»ç»Ÿç®¡ç†"ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ— æ³•å±•å¼€æŸ¥çœ‹å®Œæ•´çš„æƒé™æ ‘ç»“æ„ã€‚

## ğŸ” é—®é¢˜åŸå› åˆ†æ

### 1. åç«¯é—®é¢˜ï¼šchildren å­—æ®µç¼ºå¤±

**é—®é¢˜1**: `Permission` å®ä½“ç±»æ²¡æœ‰ `children` å­—æ®µ
- `Permission.java` ä¸­æ²¡æœ‰å®šä¹‰ children å±æ€§
- å³ä½¿æ„å»ºäº†æ ‘å½¢ç»“æ„ï¼Œä¹Ÿæ— æ³•é€šè¿‡JSONåºåˆ—åŒ–è¿”å›ç»™å‰ç«¯

**é—®é¢˜2**: `buildChildren` æ–¹æ³•æ²¡æœ‰è®¾ç½® children
```java
// ä¹‹å‰çš„ä»£ç 
private void buildChildren(Permission parent, List<Permission> allPermissions) {
    List<Permission> children = allPermissions.stream()
            .filter(p -> parent.getId().equals(p.getParentId()))
            .collect(Collectors.toList());
    
    // âŒ ç¼ºå°‘è¿™ä¸€è¡Œï¼šparent.setChildren(children);
    
    if (!children.isEmpty()) {
        for (Permission child : children) {
            buildChildren(child, allPermissions);
        }
    }
}
```

### 2. æ•°æ®åº“é—®é¢˜ï¼šparent_id é”™è¯¯

æ•°æ®åº“ä¸­çš„æƒé™ parent_id æŒ‡å‘å·²åˆ é™¤çš„æ—§æƒé™IDï¼š

| ID | æƒé™åç§° | parent_id | é—®é¢˜ |
|----|---------|-----------|------|
| 6 | ç”¨æˆ·ç®¡ç† | 1 | âŒ ID=1çš„æƒé™ä¸å­˜åœ¨ |
| 7 | ç”¨æˆ·æŸ¥è¯¢ | 2 | âŒ ID=2çš„æƒé™ä¸å­˜åœ¨ |
| 12 | è§’è‰²ç®¡ç† | 1 | âŒ ID=1çš„æƒé™ä¸å­˜åœ¨ |
| 13 | è§’è‰²æŸ¥è¯¢ | 8 | âŒ ID=8çš„æƒé™ä¸å­˜åœ¨ |

å®é™…åº”è¯¥çš„å…³ç³»ï¼š
- ç”¨æˆ·ç®¡ç†(6) â†’ çˆ¶æƒé™ï¼šç³»ç»Ÿç®¡ç†(5)
- ç”¨æˆ·æŸ¥è¯¢(7) â†’ çˆ¶æƒé™ï¼šç”¨æˆ·ç®¡ç†(6)
- è§’è‰²ç®¡ç†(12) â†’ çˆ¶æƒé™ï¼šç³»ç»Ÿç®¡ç†(5)
- è§’è‰²æŸ¥è¯¢(13) â†’ çˆ¶æƒé™ï¼šè§’è‰²ç®¡ç†(12)

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ  children å­—æ®µåˆ° Permission å®ä½“

**æ–‡ä»¶**: `/backend/src/main/java/com/wuxing/entity/Permission.java`

```java
import com.baomidou.mybatisplus.annotation.TableField;
import java.util.List;

@Data
@EqualsAndHashCode(callSuper = true)
@TableName("sys_permission")
public class Permission extends BaseEntity {
    
    // ... å…¶ä»–å­—æ®µ ...
    
    /**
     * å­æƒé™åˆ—è¡¨ï¼ˆéæ•°æ®åº“å­—æ®µï¼‰
     */
    @TableField(exist = false)  // âœ… æ ‡è®°ä¸ºéæ•°æ®åº“å­—æ®µ
    private List<Permission> children;
}
```

**è¯´æ˜**:
- `@TableField(exist = false)` å‘Šè¯‰ MyBatis-Plus è¿™ä¸æ˜¯æ•°æ®åº“å­—æ®µ
- ä»…ç”¨äºæ ‘å½¢ç»“æ„å±•ç¤ºï¼Œä¸å‚ä¸æ•°æ®åº“æ“ä½œ

### 2. ä¿®å¤ buildChildren æ–¹æ³•

**æ–‡ä»¶**: `/backend/src/main/java/com/wuxing/service/impl/PermissionServiceImpl.java`

```java
private void buildChildren(Permission parent, List<Permission> allPermissions) {
    List<Permission> children = allPermissions.stream()
            .filter(p -> parent.getId().equals(p.getParentId()))
            .collect(Collectors.toList());
    
    // âœ… è®¾ç½®å­æƒé™åˆ—è¡¨
    parent.setChildren(children);
    
    // é€’å½’æ„å»ºå­èŠ‚ç‚¹çš„å­æƒé™
    if (!children.isEmpty()) {
        for (Permission child : children) {
            buildChildren(child, allPermissions);
        }
    }
}
```

### 3. ä¿®å¤æ•°æ®åº“ parent_id

**SQL ä¿®å¤è„šæœ¬**:
```sql
-- ç”¨æˆ·ç®¡ç†ã€è§’è‰²ç®¡ç†ã€æƒé™ç®¡ç†çš„çˆ¶æƒé™åº”è¯¥æ˜¯ç³»ç»Ÿç®¡ç†(id=5)
UPDATE sys_permission SET parent_id = 5 WHERE id IN (6, 12, 19);

-- ç”¨æˆ·ç®¡ç†ä¸‹çš„å­æƒé™ï¼Œçˆ¶æƒé™åº”è¯¥æ˜¯ç”¨æˆ·ç®¡ç†(id=6)
UPDATE sys_permission SET parent_id = 6 WHERE id IN (7, 8, 9, 10, 11);

-- è§’è‰²ç®¡ç†ä¸‹çš„å­æƒé™ï¼Œçˆ¶æƒé™åº”è¯¥æ˜¯è§’è‰²ç®¡ç†(id=12)
UPDATE sys_permission SET parent_id = 12 WHERE id IN (13, 14, 15, 16, 17, 18);

-- æƒé™ç®¡ç†ä¸‹çš„å­æƒé™ï¼Œçˆ¶æƒé™åº”è¯¥æ˜¯æƒé™ç®¡ç†(id=19)
UPDATE sys_permission SET parent_id = 19 WHERE id IN (20, 21, 22, 23, 24);
```

---

## ğŸ“Š ä¿®å¤åçš„æƒé™æ ‘ç»“æ„

### æ•°æ®åº“ç»“æ„
```
ç³»ç»Ÿç®¡ç† (id=5, parent_id=0)
â”œâ”€â”€ ç”¨æˆ·ç®¡ç† (id=6, parent_id=5)
â”‚   â”œâ”€â”€ ç”¨æˆ·æŸ¥è¯¢ (id=7, parent_id=6)
â”‚   â”œâ”€â”€ ç”¨æˆ·åˆ—è¡¨ (id=8, parent_id=6)
â”‚   â”œâ”€â”€ ç”¨æˆ·æ–°å¢ (id=9, parent_id=6)
â”‚   â”œâ”€â”€ ç”¨æˆ·ç¼–è¾‘ (id=10, parent_id=6)
â”‚   â””â”€â”€ ç”¨æˆ·åˆ é™¤ (id=11, parent_id=6)
â”œâ”€â”€ è§’è‰²ç®¡ç† (id=12, parent_id=5)
â”‚   â”œâ”€â”€ è§’è‰²æŸ¥è¯¢ (id=13, parent_id=12)
â”‚   â”œâ”€â”€ è§’è‰²åˆ—è¡¨ (id=14, parent_id=12)
â”‚   â”œâ”€â”€ è§’è‰²æ–°å¢ (id=15, parent_id=12)
â”‚   â”œâ”€â”€ è§’è‰²ç¼–è¾‘ (id=16, parent_id=12)
â”‚   â”œâ”€â”€ è§’è‰²åˆ é™¤ (id=17, parent_id=12)
â”‚   â””â”€â”€ è§’è‰²åˆ†é…æƒé™ (id=18, parent_id=12)
â””â”€â”€ æƒé™ç®¡ç† (id=19, parent_id=5)
    â”œâ”€â”€ æƒé™æŸ¥è¯¢ (id=20, parent_id=19)
    â”œâ”€â”€ æƒé™åˆ—è¡¨ (id=21, parent_id=19)
    â”œâ”€â”€ æƒé™æ–°å¢ (id=22, parent_id=19)
    â”œâ”€â”€ æƒé™ç¼–è¾‘ (id=23, parent_id=19)
    â””â”€â”€ æƒé™åˆ é™¤ (id=24, parent_id=19)
```

### API è¿”å›ç»“æ„
```json
{
  "code": 200,
  "data": [
    {
      "id": 5,
      "permissionName": "ç³»ç»Ÿç®¡ç†",
      "permissionCode": "system",
      "children": [
        {
          "id": 6,
          "permissionName": "ç”¨æˆ·ç®¡ç†",
          "permissionCode": "system:user",
          "children": [
            {
              "id": 7,
              "permissionName": "ç”¨æˆ·æŸ¥è¯¢",
              "permissionCode": "system:user:query",
              "children": []
            },
            ...
          ]
        },
        {
          "id": 12,
          "permissionName": "è§’è‰²ç®¡ç†",
          "permissionCode": "system:role",
          "children": [...]
        },
        {
          "id": 19,
          "permissionName": "æƒé™ç®¡ç†",
          "permissionCode": "system:permission",
          "children": [...]
        }
      ]
    }
  ]
}
```

---

## ğŸ§ª éªŒè¯ä¿®å¤

### 1. åç«¯æ¥å£æµ‹è¯•

```bash
# 1. ç™»å½•è·å–Token
TOKEN=$(curl -s -X POST http://localhost:8080/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | grep -o '"token":"[^"]*' | cut -d'"' -f4)

# 2. æµ‹è¯•æƒé™æ ‘æ¥å£
curl -X GET "http://localhost:8080/api/permission/tree" \
  -H "Authorization: Bearer $TOKEN" \
  | python3 -m json.tool
```

**é¢„æœŸç»“æœ**:
```json
{
  "code": 200,
  "data": [
    {
      "permissionName": "ç³»ç»Ÿç®¡ç†",
      "children": [
        {
          "permissionName": "ç”¨æˆ·ç®¡ç†",
          "children": [
            {"permissionName": "ç”¨æˆ·æŸ¥è¯¢"},
            {"permissionName": "ç”¨æˆ·åˆ—è¡¨"},
            ...
          ]
        },
        ...
      ]
    }
  ]
}
```

### 2. å‰ç«¯é¡µé¢æµ‹è¯•

1. è®¿é—® `http://localhost:3000`
2. ç™»å½•ï¼š`admin / admin123`
3. è¿›å…¥ï¼šç³»ç»Ÿç®¡ç† â†’ è§’è‰²ç®¡ç†
4. ç‚¹å‡»ä»»æ„è§’è‰²çš„"åˆ†é…æƒé™"æŒ‰é’®

**é¢„æœŸç»“æœ**:
- âœ… å¯¹è¯æ¡†æ˜¾ç¤ºå®Œæ•´çš„æƒé™æ ‘
- âœ… å¯ä»¥å±•å¼€"ç³»ç»Ÿç®¡ç†"èŠ‚ç‚¹
- âœ… æ˜¾ç¤º3ä¸ªå­èŠ‚ç‚¹ï¼šç”¨æˆ·ç®¡ç†ã€è§’è‰²ç®¡ç†ã€æƒé™ç®¡ç†
- âœ… æ¯ä¸ªå­èŠ‚ç‚¹å¯ä»¥ç»§ç»­å±•å¼€æŸ¥çœ‹æŒ‰é’®çº§æƒé™

### 3. æ•°æ®éªŒè¯

```sql
-- éªŒè¯parent_idæ­£ç¡®æ€§
SELECT 
    p.id,
    p.permission_name,
    p.parent_id,
    parent.permission_name AS parent_name
FROM sys_permission p
LEFT JOIN sys_permission parent ON p.parent_id = parent.id
WHERE p.deleted = 0
ORDER BY p.parent_id, p.id;
```

**é¢„æœŸç»“æœ**:
- æ‰€æœ‰ parent_id éƒ½èƒ½æ‰¾åˆ°å¯¹åº”çš„çˆ¶æƒé™
- æ— å­¤å„¿èŠ‚ç‚¹ï¼ˆparent_id æŒ‡å‘ä¸å­˜åœ¨çš„IDï¼‰

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶
1. `/backend/src/main/java/com/wuxing/entity/Permission.java`
   - æ·»åŠ  `children` å­—æ®µ
   - æ·»åŠ  `@TableField(exist = false)` æ³¨è§£

2. `/backend/src/main/java/com/wuxing/service/impl/PermissionServiceImpl.java`
   - ä¿®å¤ `buildChildren` æ–¹æ³•
   - æ·»åŠ  `parent.setChildren(children)` è°ƒç”¨

### æ•°æ®åº“ä¿®å¤
```sql
-- æ›´æ–°äº†20ä¸ªæƒé™çš„ parent_id
UPDATE sys_permission SET parent_id = 5 WHERE id IN (6, 12, 19);
UPDATE sys_permission SET parent_id = 6 WHERE id IN (7, 8, 9, 10, 11);
UPDATE sys_permission SET parent_id = 12 WHERE id IN (13, 14, 15, 16, 17, 18);
UPDATE sys_permission SET parent_id = 19 WHERE id IN (20, 21, 22, 23, 24);
```

---

## ğŸ¯ æŠ€æœ¯è¦ç‚¹

### 1. @TableField(exist = false)
è¿™ä¸ªæ³¨è§£å‘Šè¯‰ MyBatis-Plusï¼š
- è¯¥å­—æ®µä¸å¯¹åº”æ•°æ®åº“è¡¨ä¸­çš„åˆ—
- ä¸å‚ä¸ INSERTã€UPDATEã€SELECT æ“ä½œ
- ä»…ç”¨äºä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚æ ‘å½¢ç»“æ„ï¼‰

### 2. æ ‘å½¢ç»“æ„æ„å»º
```java
// æ ¸å¿ƒé€»è¾‘
1. æ‰¾åˆ°æ‰€æœ‰é¡¶çº§èŠ‚ç‚¹ï¼ˆparentId = 0ï¼‰
2. å¯¹æ¯ä¸ªé¡¶çº§èŠ‚ç‚¹é€’å½’æ„å»ºå­æ ‘
3. åœ¨æ¯å±‚é€’å½’ä¸­ï¼š
   - æ‰¾åˆ°å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹
   - è®¾ç½® children å­—æ®µ
   - å¯¹æ¯ä¸ªå­èŠ‚ç‚¹ç»§ç»­é€’å½’
```

### 3. å‰ç«¯æ ‘å½¢ç»„ä»¶
```vue
<el-tree
  :data="permissionTreeData"  <!-- ç»‘å®šæ ‘å½¢æ•°æ® -->
  node-key="id"                <!-- èŠ‚ç‚¹å”¯ä¸€æ ‡è¯† -->
  :props="{ 
    label: 'permissionName',   <!-- æ˜¾ç¤ºå­—æ®µ -->
    children: 'children'       <!-- å­èŠ‚ç‚¹å­—æ®µ -->
  }"
/>
```

---

## âœ… ä¿®å¤å®Œæˆ

ç°åœ¨æƒé™æ ‘åŠŸèƒ½å·²ç»å®Œå…¨æ­£å¸¸ï¼š

âœ… **åç«¯æ­£ç¡®è¿”å›æ ‘å½¢ç»“æ„**
- Permission å®ä½“åŒ…å« children å­—æ®µ
- buildChildren æ–¹æ³•æ­£ç¡®è®¾ç½®å­æƒé™
- API è¿”å›å®Œæ•´çš„ä¸‰å±‚æ ‘å½¢ç»“æ„

âœ… **æ•°æ®åº“å…³ç³»æ­£ç¡®**
- æ‰€æœ‰ parent_id æŒ‡å‘æ­£ç¡®çš„çˆ¶æƒé™
- ä¸‰å±‚ç»“æ„ï¼šç³»ç»Ÿç®¡ç† â†’ æ¨¡å—ç®¡ç† â†’ æŒ‰é’®æƒé™

âœ… **å‰ç«¯æ­£å¸¸æ˜¾ç¤º**
- æƒé™æ ‘å¯ä»¥å®Œæ•´å±•å¼€
- æ˜¾ç¤ºæ‰€æœ‰20ä¸ªæƒé™
- æ ‘å½¢ç»“æ„å±‚çº§æ¸…æ™°

åˆ·æ–°é¡µé¢å³å¯çœ‹åˆ°å®Œæ•´çš„æƒé™æ ‘ï¼ğŸ‰
