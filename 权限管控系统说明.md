# æƒé™ç®¡æ§ç³»ç»Ÿå®ç°æ–‡æ¡£

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. æƒé™ç®¡ç†æ¨¡å—

#### 1.1 æ•°æ®åº“è¡¨è®¾è®¡
- âœ… `sys_permission` - æƒé™è¡¨
- âœ… `sys_role` - è§’è‰²è¡¨
- âœ… `sys_user` - ç”¨æˆ·è¡¨
- âœ… `sys_role_permission` - è§’è‰²-æƒé™å…³è”è¡¨
- âœ… `sys_user_role` - ç”¨æˆ·-è§’è‰²å…³è”è¡¨

#### 1.2 åç«¯å®ä½“å’ŒæœåŠ¡
- âœ… `Permission` å®ä½“ç±»
- âœ… `RolePermission` å…³è”å®ä½“
- âœ… `UserRole` å…³è”å®ä½“
- âœ… `PermissionService` - æƒé™æœåŠ¡
- âœ… `PermissionMapper` - æ•°æ®è®¿é—®å±‚

#### 1.3 æƒé™æ§åˆ¶æ³¨è§£
- âœ… `@RequiresPermission` - æ–¹æ³•çº§æƒé™æ§åˆ¶æ³¨è§£
- âœ… `PermissionAspect` - AOPæƒé™éªŒè¯åˆ‡é¢

### 2. æƒé™ç®¡ç†æ¥å£

#### 2.1 æƒé™CRUDæ¥å£
```
GET    /api/permission/list       # æƒé™åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
GET    /api/permission/tree       # æƒé™æ ‘ï¼ˆå±‚çº§ç»“æ„ï¼‰
GET    /api/permission/{id}       # æƒé™è¯¦æƒ…
POST   /api/permission            # æ–°å¢æƒé™
PUT    /api/permission/{id}       # æ›´æ–°æƒé™
DELETE /api/permission/{id}       # åˆ é™¤æƒé™
```

#### 2.2 è§’è‰²-æƒé™ç®¡ç†æ¥å£
```
GET    /api/permission/role/{roleId}          # è·å–è§’è‰²çš„æƒé™åˆ—è¡¨
POST   /api/permission/role/{roleId}          # åˆ†é…æƒé™ç»™è§’è‰²
GET    /api/permission/current                # è·å–å½“å‰ç”¨æˆ·çš„æƒé™
```

### 3. å·²æ·»åŠ æƒé™æ§åˆ¶çš„æ¥å£

#### 3.1 ç”¨æˆ·ç®¡ç†æ¥å£
- âœ… `GET /api/user/list` - éœ€è¦ `system:user:list` æƒé™
- âœ… `GET /api/user/{id}` - éœ€è¦ `system:user:query` æƒé™
- âœ… `POST /api/user/register` - éœ€è¦ `system:user:add` æƒé™
- âœ… `PUT /api/user/update` - éœ€è¦ `system:user:edit` æƒé™
- âœ… `DELETE /api/user/{id}` - éœ€è¦ `system:user:delete` æƒé™

#### 3.2 è§’è‰²ç®¡ç†æ¥å£
- âœ… `GET /api/role/list` - éœ€è¦ `system:role:list` æƒé™
- âœ… `GET /api/role/{id}` - éœ€è¦ `system:role:query` æƒé™
- âœ… `POST /api/role` - éœ€è¦ `system:role:add` æƒé™
- âœ… `PUT /api/role/{id}` - éœ€è¦ `system:role:edit` æƒé™
- âœ… `DELETE /api/role/{id}` - éœ€è¦ `system:role:delete` æƒé™
- âœ… `POST /api/permission/role/{roleId}` - éœ€è¦ `system:role:assign` æƒé™

#### 3.3 æƒé™ç®¡ç†æ¥å£
- âœ… `POST /api/permission` - éœ€è¦ `system:permission:add` æƒé™
- âœ… `PUT /api/permission/{id}` - éœ€è¦ `system:permission:edit` æƒé™
- âœ… `DELETE /api/permission/{id}` - éœ€è¦ `system:permission:delete` æƒé™

---

## ğŸ“Š æƒé™æ•°æ®ç»“æ„

### æƒé™ç±»å‹
1. **èœå•æƒé™** (`permission_type = 1`) - é¡µé¢çº§æƒé™
2. **æŒ‰é’®æƒé™** (`permission_type = 2`) - æ“ä½œçº§æƒé™

### åˆå§‹æƒé™åˆ—è¡¨

```
ç³»ç»Ÿç®¡ç† (system)
â”œâ”€â”€ ç”¨æˆ·ç®¡ç† (system:user)
â”‚   â”œâ”€â”€ ç”¨æˆ·æŸ¥è¯¢ (system:user:query)
â”‚   â”œâ”€â”€ ç”¨æˆ·åˆ—è¡¨ (system:user:list)
â”‚   â”œâ”€â”€ ç”¨æˆ·æ–°å¢ (system:user:add)
â”‚   â”œâ”€â”€ ç”¨æˆ·ç¼–è¾‘ (system:user:edit)
â”‚   â””â”€â”€ ç”¨æˆ·åˆ é™¤ (system:user:delete)
â”œâ”€â”€ è§’è‰²ç®¡ç† (system:role)
â”‚   â”œâ”€â”€ è§’è‰²æŸ¥è¯¢ (system:role:query)
â”‚   â”œâ”€â”€ è§’è‰²åˆ—è¡¨ (system:role:list)
â”‚   â”œâ”€â”€ è§’è‰²æ–°å¢ (system:role:add)
â”‚   â”œâ”€â”€ è§’è‰²ç¼–è¾‘ (system:role:edit)
â”‚   â”œâ”€â”€ è§’è‰²åˆ é™¤ (system:role:delete)
â”‚   â””â”€â”€ è§’è‰²åˆ†é…æƒé™ (system:role:assign)
â””â”€â”€ æƒé™ç®¡ç† (system:permission)
    â”œâ”€â”€ æƒé™æŸ¥è¯¢ (system:permission:query)
    â”œâ”€â”€ æƒé™åˆ—è¡¨ (system:permission:list)
    â”œâ”€â”€ æƒé™æ–°å¢ (system:permission:add)
    â”œâ”€â”€ æƒé™ç¼–è¾‘ (system:permission:edit)
    â””â”€â”€ æƒé™åˆ é™¤ (system:permission:delete)
```

### è§’è‰²æƒé™åˆ†é…

#### è¶…çº§ç®¡ç†å‘˜ (SUPER_ADMIN)
- âœ… æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼ˆ20ä¸ªï¼‰

#### ç®¡ç†å‘˜ (ADMIN)
- âœ… ç”¨æˆ·ç®¡ç†å…¨éƒ¨æƒé™
- âœ… è§’è‰²ç®¡ç†å…¨éƒ¨æƒé™
- âŒ æ— æƒé™ç®¡ç†æƒé™

#### æ™®é€šç”¨æˆ· (USER)
- âœ… ç”¨æˆ·æŸ¥è¯¢ã€åˆ—è¡¨æƒé™
- âœ… è§’è‰²æŸ¥è¯¢ã€åˆ—è¡¨æƒé™
- âŒ æ— å¢åˆ æ”¹æƒé™

---

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. åç«¯ä½¿ç”¨æƒé™æ³¨è§£

#### æ–¹æ³•çº§æƒé™æ§åˆ¶

```java
@RestController
@RequestMapping("/api/user")
public class UserController {
    
    // éœ€è¦å•ä¸ªæƒé™
    @PostMapping
    @RequiresPermission("system:user:add")
    public Result<Void> createUser(@RequestBody User user) {
        // ...
    }
    
    // éœ€è¦å¤šä¸ªæƒé™ï¼ˆANDå…³ç³» - å¿…é¡»å…¨éƒ¨æ‹¥æœ‰ï¼‰
    @PutMapping("/{id}")
    @RequiresPermission(value = {"system:user:edit", "system:user:query"}, logical = Logical.AND)
    public Result<Void> updateUser(@PathVariable Long id, @RequestBody User user) {
        // ...
    }
    
    // éœ€è¦å¤šä¸ªæƒé™ï¼ˆORå…³ç³» - æ‹¥æœ‰ä»»ä¸€å³å¯ï¼‰
    @GetMapping("/list")
    @RequiresPermission(value = {"system:user:list", "system:user:query"}, logical = Logical.OR)
    public Result<List<User>> list() {
        // ...
    }
}
```

### 2. æƒé™éªŒè¯æµç¨‹

```
1. å‰ç«¯å‘èµ·è¯·æ±‚ â†’ æºå¸¦JWT Token
2. JwtAuthenticationFilter éªŒè¯Tokenå¹¶æå–ç”¨æˆ·ä¿¡æ¯
3. PermissionAspect æ‹¦æˆªå¸¦æœ‰ @RequiresPermission æ³¨è§£çš„æ–¹æ³•
4. ä»Tokenä¸­è·å–ç”¨æˆ·ID
5. æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰æƒé™ï¼ˆé€šè¿‡ç”¨æˆ·â†’è§’è‰²â†’æƒé™å…³è”ï¼‰
6. éªŒè¯ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æ‰€éœ€æƒé™
7. éªŒè¯é€šè¿‡ â†’ æ‰§è¡Œæ–¹æ³•
8. éªŒè¯å¤±è´¥ â†’ æŠ›å‡º BusinessException("æƒé™ä¸è¶³")
```

### 3. åˆ†é…æƒé™ç»™è§’è‰²

```bash
# ç¤ºä¾‹ï¼šåˆ†é…æƒé™ç»™è§’è‰²
POST /api/permission/role/1
Authorization: Bearer {token}
Content-Type: application/json

[1, 2, 3, 4, 5, 6, 7]  # æƒé™IDæ•°ç»„
```

### 4. æŸ¥è¯¢è§’è‰²çš„æƒé™

```bash
GET /api/permission/role/1
Authorization: Bearer {token}

# è¿”å›
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "permissionName": "ç³»ç»Ÿç®¡ç†",
      "permissionCode": "system",
      ...
    },
    ...
  ]
}
```

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### 1. æµ‹è¯•è¶…çº§ç®¡ç†å‘˜æƒé™

```bash
# 1. ç™»å½•è·å–Token
TOKEN=$(curl -s -X POST http://localhost:8080/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | jq -r '.data.token')

# 2. æµ‹è¯•ç”¨æˆ·åˆ—è¡¨ï¼ˆéœ€è¦ system:user:list æƒé™ï¼‰
curl -X GET "http://localhost:8080/api/user/list?current=1&size=10" \
  -H "Authorization: Bearer $TOKEN"

# åº”è¯¥æˆåŠŸè¿”å›æ•°æ®

# 3. æµ‹è¯•æ–°å¢æƒé™ï¼ˆéœ€è¦ system:permission:add æƒé™ï¼‰
curl -X POST http://localhost:8080/api/permission \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "permissionName": "æµ‹è¯•æƒé™",
    "permissionCode": "test:permission",
    "permissionType": 2,
    "parentId": 0,
    "status": 1
  }'

# åº”è¯¥æˆåŠŸåˆ›å»º
```

### 2. æµ‹è¯•æƒé™ä¸è¶³çš„æƒ…å†µ

```bash
# 1. åˆ›å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·ï¼ˆåªæœ‰æŸ¥è¯¢æƒé™ï¼‰
# 2. ç™»å½•è·å–Token
# 3. å°è¯•åˆ é™¤ç”¨æˆ·ï¼ˆéœ€è¦ system:user:delete æƒé™ï¼‰

curl -X DELETE http://localhost:8080/api/user/1 \
  -H "Authorization: Bearer $NORMAL_USER_TOKEN"

# åº”è¯¥è¿”å› 403 æˆ– "æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤æ“ä½œ"
```

---

## ğŸ“ æƒé™ç¼–ç è§„èŒƒ

### å‘½åè§„åˆ™
- **æ¨¡å—:åŠŸèƒ½:æ“ä½œ**
- å…¨å°å†™ï¼Œä½¿ç”¨å†’å·åˆ†éš”
- ä¾‹å¦‚ï¼š`system:user:add`

### å¸¸ç”¨æ“ä½œ
- `query` - æŸ¥è¯¢å•ä¸ª
- `list` - åˆ—è¡¨æŸ¥è¯¢
- `add` - æ–°å¢
- `edit` - ç¼–è¾‘
- `delete` - åˆ é™¤
- `export` - å¯¼å‡º
- `import` - å¯¼å…¥
- `assign` - åˆ†é…

### ç¤ºä¾‹
```
system:user:query       # æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…
system:user:list        # ç”¨æˆ·åˆ—è¡¨
system:user:add         # æ–°å¢ç”¨æˆ·
system:user:edit        # ç¼–è¾‘ç”¨æˆ·
system:user:delete      # åˆ é™¤ç”¨æˆ·
system:user:export      # å¯¼å‡ºç”¨æˆ·
system:role:assign      # åˆ†é…æƒé™ç»™è§’è‰²
```

---

## ğŸ¯ å‰ç«¯å¯¹æ¥å»ºè®®

### 1. æŒ‰é’®çº§æƒé™æ§åˆ¶

```vue
<template>
  <div>
    <!-- æœ‰æƒé™æ‰æ˜¾ç¤ºæŒ‰é’® -->
    <el-button 
      v-if="hasPermission('system:user:add')" 
      type="primary" 
      @click="handleAdd"
    >
      æ–°å¢ç”¨æˆ·
    </el-button>
    
    <el-button 
      v-if="hasPermission('system:user:edit')" 
      type="warning" 
      @click="handleEdit"
    >
      ç¼–è¾‘
    </el-button>
    
    <el-button 
      v-if="hasPermission('system:user:delete')" 
      type="danger" 
      @click="handleDelete"
    >
      åˆ é™¤
    </el-button>
  </div>
</template>

<script setup>
import { usePermissionStore } from '@/stores/permission'

const permissionStore = usePermissionStore()

// æ£€æŸ¥æƒé™
const hasPermission = (permissionCode) => {
  return permissionStore.hasPermission(permissionCode)
}
</script>
```

### 2. æƒé™Store

```javascript
// stores/permission.js
import { defineStore } from 'pinia'
import { getPermissions } from '@/api/permission'

export const usePermissionStore = defineStore('permission', {
  state: () => ({
    permissions: []
  }),
  
  getters: {
    permissionCodes: (state) => {
      return state.permissions.map(p => p.permissionCode)
    }
  },
  
  actions: {
    async loadPermissions() {
      const res = await getPermissions()
      this.permissions = res.data
    },
    
    hasPermission(permissionCode) {
      return this.permissionCodes.includes(permissionCode)
    },
    
    hasAnyPermission(permissionCodes) {
      return permissionCodes.some(code => this.hasPermission(code))
    },
    
    hasAllPermissions(permissionCodes) {
      return permissionCodes.every(code => this.hasPermission(code))
    }
  }
})
```

### 3. æƒé™æŒ‡ä»¤

```javascript
// directives/permission.js
export default {
  mounted(el, binding) {
    const { value } = binding
    const permissionStore = usePermissionStore()
    
    if (value && !permissionStore.hasPermission(value)) {
      el.parentNode && el.parentNode.removeChild(el)
    }
  }
}

// ä½¿ç”¨
<el-button v-permission="'system:user:add'">æ–°å¢</el-button>
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

1. **æœ€å°æƒé™åŸåˆ™**
   - ç”¨æˆ·åªåˆ†é…å¿…éœ€çš„æƒé™
   - å®šæœŸå®¡æŸ¥æƒé™åˆ†é…

2. **æƒé™ç²’åº¦**
   - èœå•çº§ï¼šæ§åˆ¶é¡µé¢è®¿é—®
   - æŒ‰é’®çº§ï¼šæ§åˆ¶æ“ä½œæ‰§è¡Œ

3. **å‰åç«¯åŒé‡éªŒè¯**
   - å‰ç«¯ï¼šUIæ§åˆ¶ï¼ˆéšè—æŒ‰é’®ï¼‰
   - åç«¯ï¼šæ¥å£éªŒè¯ï¼ˆå¿…é¡»ï¼‰

4. **æƒé™ç¼“å­˜**
   - ç”¨æˆ·æƒé™å¯ç¼“å­˜ï¼ˆRedisï¼‰
   - æƒé™å˜æ›´æ—¶æ¸…é™¤ç¼“å­˜

5. **å®¡è®¡æ—¥å¿—**
   - è®°å½•æƒé™å˜æ›´
   - è®°å½•æ•æ„Ÿæ“ä½œ

---

## ğŸ“‹ TODOï¼ˆå¯é€‰æ‰©å±•ï¼‰

- â³ æ•°æ®æƒé™ï¼ˆéƒ¨é—¨ã€ç”¨æˆ·æ•°æ®éš”ç¦»ï¼‰
- â³ åŠ¨æ€è·¯ç”±ï¼ˆæ ¹æ®æƒé™ç”Ÿæˆå‰ç«¯è·¯ç”±ï¼‰
- â³ æƒé™ç¼“å­˜ï¼ˆRedisï¼‰
- â³ æƒé™å˜æ›´é€šçŸ¥
- â³ æ“ä½œå®¡è®¡æ—¥å¿—
- â³ æƒé™æ‰¹é‡å¯¼å…¥å¯¼å‡º
- â³ è§’è‰²ç»§æ‰¿
- â³ æƒé™ç»„

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### åç«¯æ–‡ä»¶
- `/backend/src/main/java/com/wuxing/entity/Permission.java`
- `/backend/src/main/java/com/wuxing/entity/RolePermission.java`
- `/backend/src/main/java/com/wuxing/entity/UserRole.java`
- `/backend/src/main/java/com/wuxing/mapper/PermissionMapper.java`
- `/backend/src/main/java/com/wuxing/service/PermissionService.java`
- `/backend/src/main/java/com/wuxing/controller/PermissionController.java`
- `/backend/src/main/java/com/wuxing/annotation/RequiresPermission.java`
- `/backend/src/main/java/com/wuxing/aspect/PermissionAspect.java`
- `/backend/sql/data.sql`

### æ•°æ®åº“è¡¨
- `sys_permission`
- `sys_role`
- `sys_user`
- `sys_role_permission`
- `sys_user_role`
