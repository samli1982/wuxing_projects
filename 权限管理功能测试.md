# 权限管理功能测试指南

## 🎯 测试目标

验证前后端权限管理系统的完整功能，包括：
- 权限CRUD操作
- 角色权限分配
- 前端权限控制（按钮级）
- 后端权限验证（接口级）

---

## 📋 测试环境

### 服务状态
- ✅ 后端服务：http://localhost:8080
- ✅ 前端服务：http://localhost:3000
- ✅ 数据库：wuxing_db (MySQL 8.0)

### 测试账号

| 用户名 | 密码 | 角色 | 权限范围 |
|--------|------|------|----------|
| admin | admin123 | 超级管理员 | 所有权限（20个） |
| manager | manager123 | 管理员 | 用户+角色管理（13个） |
| user | user123 | 普通用户 | 仅查询权限（7个） |

---

## 🧪 测试用例

### 一、权限管理页面测试

#### 1.1 访问权限管理页面

**步骤**：
1. 使用 admin 账号登录
2. 点击左侧菜单"权限管理"

**预期结果**：
- ✅ 成功进入权限管理页面
- ✅ 显示权限列表（树形结构）
- ✅ 显示20个权限数据
- ✅ 顶部显示"新增权限"按钮

#### 1.2 查看权限列表

**预期显示内容**：
```
系统管理 (system)
├── 用户管理 (system:user)
│   ├── 用户查询 (system:user:query)
│   ├── 用户列表 (system:user:list)
│   ├── 用户新增 (system:user:add)
│   ├── 用户编辑 (system:user:edit)
│   └── 用户删除 (system:user:delete)
├── 角色管理 (system:role)
│   ├── 角色查询 (system:role:query)
│   ├── 角色列表 (system:role:list)
│   ├── 角色新增 (system:role:add)
│   ├── 角色编辑 (system:role:edit)
│   ├── 角色删除 (system:role:delete)
│   └── 角色分配权限 (system:role:assign)
└── 权限管理 (system:permission)
    ├── 权限查询 (system:permission:query)
    ├── 权限列表 (system:permission:list)
    ├── 权限新增 (system:permission:add)
    ├── 权限编辑 (system:permission:edit)
    └── 权限删除 (system:permission:delete)
```

#### 1.3 新增权限

**步骤**：
1. 点击"新增权限"按钮
2. 填写表单：
   - 权限名称：`用户导出`
   - 权限编码：`system:user:export`
   - 权限类型：`按钮`
   - 父级权限：选择"用户管理"
   - 排序：`6`
   - 状态：`启用`
3. 点击"确定"

**预期结果**：
- ✅ 提示"创建成功"
- ✅ 列表自动刷新
- ✅ 新权限出现在"用户管理"下

#### 1.4 编辑权限

**步骤**：
1. 找到刚创建的"用户导出"权限
2. 点击"编辑"按钮
3. 修改权限名称为"导出用户数据"
4. 点击"确定"

**预期结果**：
- ✅ 提示"更新成功"
- ✅ 权限名称已更新
- ✅ 权限编码不可修改（禁用状态）

#### 1.5 查看权限详情

**步骤**：
1. 点击某个权限的"查看"按钮

**预期结果**：
- ✅ 弹出详情对话框
- ✅ 显示完整权限信息（ID、名称、编码、类型等）

#### 1.6 删除权限

**步骤**：
1. 点击测试权限的"删除"按钮
2. 确认删除

**预期结果**：
- ✅ 提示"删除成功"
- ✅ 权限从列表中移除

**错误测试**：
尝试删除有子权限的父权限（如"用户管理"）

**预期结果**：
- ✅ 后端返回错误："该权限下存在子权限，无法删除"

---

### 二、角色权限分配测试

#### 2.1 查看角色现有权限

**步骤**：
1. 进入"角色管理"页面
2. 找到"管理员"角色
3. 点击"分配权限"按钮

**预期结果**：
- ✅ 弹出权限树对话框
- ✅ 已有权限自动勾选（13个）
- ✅ 权限树完整显示（20个）

#### 2.2 为角色添加权限

**步骤**：
1. 在权限树中勾选"权限管理"及其所有子权限
2. 点击"确定"

**预期结果**：
- ✅ 提示"权限分配成功"
- ✅ 后端数据库更新

**验证**：
再次打开该角色的权限分配对话框，新权限已勾选

#### 2.3 移除角色权限

**步骤**：
1. 取消勾选某些权限
2. 点击"确定"

**预期结果**：
- ✅ 权限成功移除
- ✅ 数据库记录删除

---

### 三、前端权限控制测试

#### 3.1 超级管理员测试

**使用账号**：admin / admin123

**测试页面**：用户管理

**预期按钮可见性**：
- ✅ "新增用户" - 可见
- ✅ "查看" - 可见
- ✅ "编辑" - 可见
- ✅ "删除" - 可见

**测试页面**：角色管理

**预期按钮可见性**：
- ✅ "新增角色" - 可见
- ✅ "查看" - 可见
- ✅ "编辑" - 可见
- ✅ "删除" - 可见
- ✅ "分配权限" - 可见

#### 3.2 普通用户测试

**步骤**：
1. 退出登录
2. 使用 user / user123 登录

**测试页面**：用户管理

**预期按钮可见性**：
- ❌ "新增用户" - **不可见**（无权限）
- ✅ "查看" - 可见
- ❌ "编辑" - **不可见**（无权限）
- ❌ "删除" - **不可见**（无权限）

**测试页面**：角色管理

**预期按钮可见性**：
- ❌ "新增角色" - **不可见**
- ✅ "查看" - 可见
- ❌ "编辑" - **不可见**
- ❌ "删除" - **不可见**
- ❌ "分配权限" - **不可见**

---

### 四、后端权限验证测试

#### 4.1 超级管理员接口测试

**步骤**：
```bash
# 1. 登录获取Token
TOKEN=$(curl -s -X POST http://localhost:8080/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | grep -o '"token":"[^"]*' | cut -d'"' -f4)

# 2. 测试用户列表接口（需要 system:user:list 权限）
curl -X GET "http://localhost:8080/api/user/list?current=1&size=10" \
  -H "Authorization: Bearer $TOKEN"
```

**预期结果**：
- ✅ 返回 200
- ✅ 成功获取用户列表数据

**步骤**：
```bash
# 3. 测试新增权限接口（需要 system:permission:add 权限）
curl -X POST http://localhost:8080/api/permission \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "permissionName": "测试权限",
    "permissionCode": "test:permission",
    "permissionType": 2,
    "parentId": 0,
    "status": 1,
    "sort": 0
  }'
```

**预期结果**：
- ✅ 返回 200
- ✅ 成功创建权限

#### 4.2 普通用户权限不足测试

**步骤**：
```bash
# 1. 登录普通用户
USER_TOKEN=$(curl -s -X POST http://localhost:8080/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"user","password":"user123"}' \
  | grep -o '"token":"[^"]*' | cut -d'"' -f4)

# 2. 尝试删除用户（需要 system:user:delete 权限）
curl -X DELETE http://localhost:8080/api/user/1 \
  -H "Authorization: Bearer $USER_TOKEN"
```

**预期结果**：
- ✅ 返回错误信息："权限不足，无法执行此操作"
- ✅ HTTP状态码 400 或 403

**步骤**：
```bash
# 3. 尝试新增角色（需要 system:role:add 权限）
curl -X POST http://localhost:8080/api/role \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "roleName": "测试角色",
    "roleCode": "TEST_ROLE",
    "status": 1
  }'
```

**预期结果**：
- ✅ 返回错误信息："权限不足，无法执行此操作"

#### 4.3 权限验证日志检查

**步骤**：
查看后端控制台日志

**预期日志**：
```
用户 3 缺少权限: [system:user:delete]
用户 1 权限验证通过: [system:user:list]
```

---

### 五、边界条件测试

#### 5.1 无Token访问

**步骤**：
```bash
curl -X GET "http://localhost:8080/api/user/list?current=1&size=10"
```

**预期结果**：
- ✅ 返回 403 Forbidden
- ✅ 或返回"未登录或token已过期"

#### 5.2 Token过期测试

**步骤**：
使用一个过期的Token访问接口

**预期结果**：
- ✅ 返回错误："未登录或token已过期"

#### 5.3 权限编码重复

**步骤**：
尝试创建一个已存在的权限编码

**预期结果**：
- ✅ 返回错误："权限编码已存在"

#### 5.4 删除有子权限的父权限

**预期结果**：
- ✅ 返回错误："该权限下存在子权限，无法删除"

---

## ✅ 测试检查清单

### 权限管理页面
- [ ] 列表展示正常
- [ ] 树形结构显示
- [ ] 新增功能正常
- [ ] 编辑功能正常
- [ ] 删除功能正常
- [ ] 查看详情正常
- [ ] 搜索功能正常
- [ ] 分页功能正常

### 角色权限分配
- [ ] 权限树展示正常
- [ ] 已有权限自动勾选
- [ ] 新增权限成功
- [ ] 移除权限成功
- [ ] 包含半选父节点

### 前端权限控制
- [ ] 有权限按钮显示
- [ ] 无权限按钮隐藏
- [ ] 指令正常工作
- [ ] Store状态正确

### 后端权限验证
- [ ] 有权限接口通过
- [ ] 无权限接口拦截
- [ ] 错误信息准确
- [ ] 日志记录完整

---

## 🐛 已知问题

暂无

---

## 📝 测试报告模板

### 测试信息
- 测试日期：____年__月__日
- 测试人员：________
- 测试环境：开发环境

### 测试结果

| 测试模块 | 测试用例数 | 通过数 | 失败数 | 通过率 |
|---------|-----------|--------|--------|--------|
| 权限管理页面 | 8 | __ | __ | __% |
| 角色权限分配 | 5 | __ | __ | __% |
| 前端权限控制 | 4 | __ | __ | __% |
| 后端权限验证 | 4 | __ | __ | __% |
| **总计** | **21** | **__** | **__** | **__%** |

### 问题列表

| 序号 | 问题描述 | 严重程度 | 状态 |
|------|---------|----------|------|
| 1 | | | |
| 2 | | | |

### 测试结论

□ 通过  □ 不通过

---

## 🚀 快速测试命令

### 完整流程测试
```bash
# 1. 登录admin
ADMIN_TOKEN=$(curl -s -X POST http://localhost:8080/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | grep -o '"token":"[^"]*' | cut -d'"' -f4)

echo "Admin Token: $ADMIN_TOKEN"

# 2. 获取权限列表
curl -s -X GET "http://localhost:8080/api/permission/list?current=1&size=20" \
  -H "Authorization: Bearer $ADMIN_TOKEN"

# 3. 获取角色的权限
curl -s -X GET "http://localhost:8080/api/permission/role/1" \
  -H "Authorization: Bearer $ADMIN_TOKEN"

# 4. 测试权限验证
curl -s -X GET "http://localhost:8080/api/user/list?current=1&size=10" \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

## 📚 相关文档

- [权限管控系统说明](/Users/saml/GoProjects/src/wuxing_projects/权限管控系统说明.md)
- [前端权限管理模块说明](/Users/saml/GoProjects/src/wuxing_projects/frontend/权限管理模块说明.md)
