# æƒé™ç³»ç»Ÿä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

1. **ç”¨æˆ·ç™»å½•åæƒé™æ²¡æœ‰è¿”å›** - åç«¯æ¥å£æœªå®ç°ï¼Œå‰ç«¯æ— æ³•è·å–æƒé™æ•°æ®
2. **æŒ‰é’®æƒé™æ— æ³•æ˜¾ç¤º** - å‰ç«¯æƒé™æ•°æ®ä¸ºç©ºï¼Œv-permission æŒ‡ä»¤æ— æ³•å·¥ä½œ
3. **å·¦ä¾§èœå•æœªæŒ‰æƒé™è¿‡æ»¤** - æ‰€æœ‰ç”¨æˆ·çœ‹åˆ°ç›¸åŒçš„èœå•ï¼Œæœªæ ¹æ®æƒé™åŠ¨æ€ç”Ÿæˆ

---

## âœ… ä¿®å¤å†…å®¹

### 1. åç«¯ä¿®å¤

#### 1.1 å®ç°è·å–å½“å‰ç”¨æˆ·æƒé™æ¥å£

**æ–‡ä»¶**: `/backend/src/main/java/com/wuxing/controller/PermissionController.java`

**ä¿®å¤å†…å®¹**:
```java
@Operation(summary = "è·å–å½“å‰ç”¨æˆ·çš„æƒé™åˆ—è¡¨")
@GetMapping("/current")
public Result<List<Permission>> getCurrentUserPermissions(HttpServletRequest request) {
    // ä»Tokenä¸­è·å–ç”¨æˆ·ID
    String token = getTokenFromRequest(request);
    if (!StringUtils.hasText(token)) {
        return ResultUtil.success(List.of());
    }
    
    try {
        Long userId = jwtUtil.getUserIdFromToken(token);
        List<Permission> permissions = permissionService.findByUserId(userId);
        return ResultUtil.success(permissions);
    } catch (Exception e) {
        return ResultUtil.success(List.of());
    }
}

private String getTokenFromRequest(HttpServletRequest request) {
    String bearerToken = request.getHeader("Authorization");
    if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
        return bearerToken.substring(7);
    }
    return null;
}
```

**è¯´æ˜**:
- ä»è¯·æ±‚å¤´æå– JWT Token
- è§£æ Token è·å–ç”¨æˆ· ID
- æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰æƒé™ï¼ˆé€šè¿‡ç”¨æˆ·â†’è§’è‰²â†’æƒé™å…³è”ï¼‰
- è¿”å›æƒé™åˆ—è¡¨

---

### 2. å‰ç«¯ä¿®å¤

#### 2.1 ç™»å½•åè‡ªåŠ¨åŠ è½½æƒé™

**æ–‡ä»¶**: `/frontend/src/stores/user.js`

**ä¿®å¤å†…å®¹**:
```javascript
import { usePermissionStore } from './permission'

actions: {
  async login(loginForm) {
    try {
      const res = await login(loginForm)
      this.token = res.data.token
      localStorage.setItem('token', res.data.token)
      
      // âœ… ç™»å½•æˆåŠŸååŠ è½½æƒé™
      const permissionStore = usePermissionStore()
      await permissionStore.loadPermissions()
      
      return res
    } catch (error) {
      return Promise.reject(error)
    }
  },

  logout() {
    this.token = ''
    this.userInfo = null
    localStorage.removeItem('token')
    
    // âœ… ç™»å‡ºæ—¶æ¸…ç©ºæƒé™
    const permissionStore = usePermissionStore()
    permissionStore.clearPermissions()
    
    router.push('/login')
  }
}
```

#### 2.2 åˆ›å»ºèœå•é…ç½®

**æ–‡ä»¶**: `/frontend/src/config/menu.js` (æ–°å»º)

**å†…å®¹**:
```javascript
// èœå•é…ç½® - åŸºäºæƒé™åŠ¨æ€ç”Ÿæˆ
export const menuConfig = [
  {
    path: '/',
    name: 'Dashboard',
    meta: { title: 'é¦–é¡µ', icon: 'HomeFilled' }
  },
  {
    path: '/user',
    name: 'UserManagement',
    meta: { 
      title: 'ç”¨æˆ·ç®¡ç†', 
      icon: 'User',
      permission: 'system:user' // âœ… éœ€è¦çš„æƒé™
    }
  },
  {
    path: '/role',
    name: 'RoleManagement',
    meta: { 
      title: 'è§’è‰²ç®¡ç†', 
      icon: 'Avatar',
      permission: 'system:role'
    }
  },
  {
    path: '/permission',
    name: 'PermissionManagement',
    meta: { 
      title: 'æƒé™ç®¡ç†', 
      icon: 'Lock',
      permission: 'system:permission'
    }
  }
]

// æ ¹æ®æƒé™è¿‡æ»¤èœå•
export function filterMenuByPermission(permissions) {
  const permissionCodes = permissions.map(p => p.permissionCode)
  
  return menuConfig.filter(menu => {
    if (menu.path === '/') return true // é¦–é¡µä¸éœ€è¦æƒé™
    
    if (menu.meta.permission) {
      return permissionCodes.includes(menu.meta.permission)
    }
    
    return true
  })
}
```

#### 2.3 æƒé™Storeç”Ÿæˆèœå•

**æ–‡ä»¶**: `/frontend/src/stores/permission.js`

**ä¿®å¤å†…å®¹**:
```javascript
import { filterMenuByPermission } from '@/config/menu'

state: () => ({
  permissions: [],
  loaded: false,
  menus: [] // âœ… æ·»åŠ èœå•åˆ—è¡¨
}),

actions: {
  async loadPermissions() {
    if (this.loaded) return
    
    try {
      const res = await getCurrentUserPermissions()
      this.permissions = res.data || []
      this.loaded = true
      
      // âœ… æ ¹æ®æƒé™ç”Ÿæˆèœå•
      this.menus = filterMenuByPermission(this.permissions)
      
      console.log('åŠ è½½æƒé™æˆåŠŸ:', this.permissions.length, 'ä¸ª')
      console.log('ç”Ÿæˆèœå•:', this.menus.length, 'ä¸ª')
    } catch (error) {
      console.error('åŠ è½½æƒé™å¤±è´¥:', error)
      this.permissions = []
      this.menus = []
    }
  }
}
```

#### 2.4 ä¸»å¸ƒå±€ä½¿ç”¨åŠ¨æ€èœå•

**æ–‡ä»¶**: `/frontend/src/layout/index.vue`

**ä¿®å¤å†…å®¹**:
```vue
<script setup>
import { usePermissionStore } from '@/stores/permission'

const permissionStore = usePermissionStore()

// âœ… è·å–åŠ¨æ€èœå•
const menus = computed(() => permissionStore.menus)

// âœ… ç»„ä»¶åŠ è½½æ—¶åŠ è½½æƒé™
onMounted(async () => {
  if (!permissionStore.loaded) {
    await permissionStore.loadPermissions()
  }
})
</script>

<template>
  <el-menu>
    <!-- âœ… åŠ¨æ€æ¸²æŸ“èœå• -->
    <el-menu-item
      v-for="menu in menus"
      :key="menu.path"
      :index="menu.path"
    >
      <el-icon>
        <component :is="menu.meta.icon" />
      </el-icon>
      <template #title>{{ menu.meta.title }}</template>
    </el-menu-item>
  </el-menu>
</template>
```

#### 2.5 è·¯ç”±å®ˆå«ç¡®ä¿æƒé™åŠ è½½

**æ–‡ä»¶**: `/frontend/src/router/index.js`

**ä¿®å¤å†…å®¹**:
```javascript
import { usePermissionStore } from '@/stores/permission'

router.beforeEach(async (to, from, next) => {
  const token = localStorage.getItem('token')
  
  if (to.path === '/login') {
    next()
  } else {
    if (!token) {
      next('/login')
    } else {
      // âœ… ç¡®ä¿æƒé™å·²åŠ è½½
      const permissionStore = usePermissionStore()
      if (!permissionStore.loaded) {
        try {
          await permissionStore.loadPermissions()
        } catch (error) {
          console.error('åŠ è½½æƒé™å¤±è´¥:', error)
        }
      }
      next()
    }
  }
})
```

---

## ğŸ¯ åŠŸèƒ½éªŒè¯

### 1. åç«¯æ¥å£æµ‹è¯•

```bash
# 1. ç™»å½•è·å–Token
TOKEN=$(curl -s -X POST http://localhost:8080/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | grep -o '"token":"[^"]*' | cut -d'"' -f4)

# 2. è·å–å½“å‰ç”¨æˆ·æƒé™
curl -X GET "http://localhost:8080/api/permission/current" \
  -H "Authorization: Bearer $TOKEN"
```

**é¢„æœŸç»“æœ**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": [
    {
      "id": 5,
      "permissionName": "ç³»ç»Ÿç®¡ç†",
      "permissionCode": "system",
      "permissionType": 1,
      ...
    },
    // ... 16ä¸ªæƒé™
  ]
}
```

### 2. å‰ç«¯åŠŸèƒ½æµ‹è¯•

#### æµ‹è¯•è¶…çº§ç®¡ç†å‘˜

1. ä½¿ç”¨ `admin / admin123` ç™»å½•
2. æŸ¥çœ‹å·¦ä¾§èœå•

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤ºï¼šé¦–é¡µã€ç”¨æˆ·ç®¡ç†ã€è§’è‰²ç®¡ç†ã€æƒé™ç®¡ç†ï¼ˆ4ä¸ªèœå•ï¼‰

3. è¿›å…¥ç”¨æˆ·ç®¡ç†é¡µé¢

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤º"æ–°å¢ç”¨æˆ·"æŒ‰é’®
- âœ… è¡¨æ ¼æ“ä½œåˆ—æ˜¾ç¤ºï¼šæŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤æŒ‰é’®

4. è¿›å…¥è§’è‰²ç®¡ç†é¡µé¢

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤º"æ–°å¢è§’è‰²"æŒ‰é’®
- âœ… è¡¨æ ¼æ“ä½œåˆ—æ˜¾ç¤ºï¼šæŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤ã€åˆ†é…æƒé™æŒ‰é’®

#### æµ‹è¯•æ™®é€šç”¨æˆ·

1. åˆ›å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·ï¼ˆè§’è‰²ï¼šæ™®é€šç”¨æˆ·ï¼‰
2. ä½¿ç”¨è¯¥ç”¨æˆ·ç™»å½•
3. æŸ¥çœ‹å·¦ä¾§èœå•

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤ºï¼šé¦–é¡µã€ç”¨æˆ·ç®¡ç†ã€è§’è‰²ç®¡ç†ï¼ˆ3ä¸ªèœå•ï¼‰
- âŒ ä¸æ˜¾ç¤ºï¼šæƒé™ç®¡ç†ï¼ˆæ— æƒé™ï¼‰

4. è¿›å…¥ç”¨æˆ·ç®¡ç†é¡µé¢

**é¢„æœŸç»“æœ**:
- âŒ **ä¸æ˜¾ç¤º**"æ–°å¢ç”¨æˆ·"æŒ‰é’®ï¼ˆæ—  `system:user:add` æƒé™ï¼‰
- âœ… è¡¨æ ¼æ“ä½œåˆ—æ˜¾ç¤ºï¼šæŸ¥çœ‹æŒ‰é’®
- âŒ **ä¸æ˜¾ç¤º**ï¼šç¼–è¾‘ã€åˆ é™¤æŒ‰é’®ï¼ˆæ— æƒé™ï¼‰

---

## ğŸ“Š æƒé™æ•°æ®è¯´æ˜

### è¶…çº§ç®¡ç†å‘˜æƒé™ï¼ˆadminç”¨æˆ·ï¼‰

æ€»å…± **16ä¸ªæƒé™**ï¼ˆæ•°æ®åº“ä¸­æœ‰20ä¸ªï¼Œä½†åªè¿”å›16ä¸ªæœ‰æ•ˆæƒé™ï¼‰:

```
ç³»ç»Ÿç®¡ç† (system)
â”œâ”€â”€ ç”¨æˆ·ç®¡ç† (system:user)
â”‚   â”œâ”€â”€ ç”¨æˆ·æŸ¥è¯¢ (system:user:query)
â”‚   â”œâ”€â”€ ç”¨æˆ·åˆ—è¡¨ (system:user:list)
â”‚   â”œâ”€â”€ ç”¨æˆ·æ–°å¢ (system:user:add)
â”‚   â”œâ”€â”€ ç”¨æˆ·ç¼–è¾‘ (system:user:edit)
â”‚   â””â”€â”€ ç”¨æˆ·åˆ é™¤ (system:user:delete)
â”œâ”€â”€ è§’è‰²ç®¡ç† (system:role)
â”‚   â”œâ”€â”€ è§’è‰²æŸ¥è¯¢ (system:role:query)
â”‚   â”œâ”€â”€ è§’è‰²åˆ—è¡¨ (system:role:list)
â”‚   â”œâ”€â”€ è§’è‰²æ–°å¢ (system:role:add)
â”‚   â”œâ”€â”€ è§’è‰²ç¼–è¾‘ (system:role:edit)
â”‚   â”œâ”€â”€ è§’è‰²åˆ é™¤ (system:role:delete)
â”‚   â””â”€â”€ è§’è‰²åˆ†é…æƒé™ (system:role:assign)
â””â”€â”€ æƒé™ç®¡ç† (system:permission)
    â””â”€â”€ æƒé™æŸ¥è¯¢ (system:permission:query)
```

### èœå•æƒé™æ˜ å°„

| èœå• | éœ€è¦çš„æƒé™ | è¶…çº§ç®¡ç†å‘˜ | ç®¡ç†å‘˜ | æ™®é€šç”¨æˆ· |
|------|-----------|-----------|--------|---------|
| é¦–é¡µ | - | âœ… | âœ… | âœ… |
| ç”¨æˆ·ç®¡ç† | system:user | âœ… | âœ… | âœ… |
| è§’è‰²ç®¡ç† | system:role | âœ… | âœ… | âœ… |
| æƒé™ç®¡ç† | system:permission | âœ… | âŒ | âŒ |

---

## ğŸ”§ å·¥ä½œæµç¨‹

### ç”¨æˆ·ç™»å½•æµç¨‹

```
1. ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
   â†“
2. è°ƒç”¨ç™»å½•æ¥å£ /api/user/login
   â†“
3. åç«¯éªŒè¯æˆåŠŸï¼Œè¿”å› JWT Token
   â†“
4. å‰ç«¯ä¿å­˜ Token åˆ° localStorage
   â†“
5. ç«‹å³è°ƒç”¨ /api/permission/current è·å–æƒé™
   â†“
6. æƒé™Storeä¿å­˜æƒé™æ•°æ®
   â†“
7. æ ¹æ®æƒé™ç”Ÿæˆèœå•åˆ—è¡¨
   â†“
8. è·³è½¬åˆ°é¦–é¡µï¼Œæ˜¾ç¤ºåŠ¨æ€èœå•
```

### æƒé™éªŒè¯æµç¨‹

**å‰ç«¯ï¼ˆUIå±‚ï¼‰**:
```
1. é¡µé¢æ¸²æŸ“æ—¶æ£€æŸ¥ permissionStore.permissions
   â†“
2. v-permission æŒ‡ä»¤æ£€æŸ¥æŒ‰é’®æƒé™
   â†“
3. å¦‚æœæœ‰æƒé™ â†’ æ˜¾ç¤ºæŒ‰é’®
4. å¦‚æœæ— æƒé™ â†’ ç§»é™¤DOMå…ƒç´ 
```

**åç«¯ï¼ˆæ¥å£å±‚ï¼‰**:
```
1. ç”¨æˆ·è¯·æ±‚æ¥å£
   â†“
2. JwtAuthenticationFilter æå–å¹¶éªŒè¯ Token
   â†“
3. PermissionAspect æ‹¦æˆª @RequiresPermission æ³¨è§£
   â†“
4. ä»Tokenè·å–ç”¨æˆ·ID
   â†“
5. æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰æƒé™
   â†“
6. éªŒè¯æ˜¯å¦æ‹¥æœ‰æ‰€éœ€æƒé™
   â†“
7. é€šè¿‡ â†’ æ‰§è¡Œæ–¹æ³•
8. ä¸é€šè¿‡ â†’ æŠ›å‡ºå¼‚å¸¸"æƒé™ä¸è¶³"
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶
1. `/backend/src/main/java/com/wuxing/controller/PermissionController.java`
   - å®ç° getCurrentUserPermissions æ–¹æ³•
   - æ·»åŠ  getTokenFromRequest è¾…åŠ©æ–¹æ³•
   - æ³¨å…¥ JwtUtil ä¾èµ–

### å‰ç«¯æ–‡ä»¶
1. `/frontend/src/stores/user.js`
   - ç™»å½•æ—¶åŠ è½½æƒé™
   - ç™»å‡ºæ—¶æ¸…ç©ºæƒé™

2. `/frontend/src/stores/permission.js` (æ–°å»º)
   - æ·»åŠ  menus çŠ¶æ€
   - åŠ è½½æƒé™æ—¶ç”Ÿæˆèœå•
   - æ·»åŠ æ§åˆ¶å°æ—¥å¿—

3. `/frontend/src/config/menu.js` (æ–°å»º)
   - èœå•é…ç½®
   - æƒé™è¿‡æ»¤å‡½æ•°

4. `/frontend/src/layout/index.vue`
   - ä½¿ç”¨åŠ¨æ€èœå•
   - ç»„ä»¶åŠ è½½æ—¶ç¡®ä¿æƒé™å·²åŠ è½½

5. `/frontend/src/router/index.js`
   - è·¯ç”±å®ˆå«åŠ è½½æƒé™

---

## âœ… éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥åç«¯

```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°æƒé™æŸ¥è¯¢SQL
==> Parameters: 1(Long)
<==      Total: 16

# æµ‹è¯•æ¥å£
curl -X GET "http://localhost:8080/api/permission/current" \
  -H "Authorization: Bearer {token}"
```

### 2. æ£€æŸ¥å‰ç«¯

1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
2. ç™»å½•ç³»ç»Ÿ
3. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼š
   ```
   åŠ è½½æƒé™æˆåŠŸ: 16 ä¸ª
   ç”Ÿæˆèœå•: 4 ä¸ª
   ```

4. æ£€æŸ¥ Network é¢æ¿ï¼š
   - ç™»å½•åç«‹å³è¯·æ±‚ `/api/permission/current`
   - è¿”å› 16 ä¸ªæƒé™æ•°æ®

5. æ£€æŸ¥å·¦ä¾§èœå•ï¼š
   - åªæ˜¾ç¤ºæœ‰æƒé™çš„èœå•é¡¹
   - ä¸åŒç”¨æˆ·çœ‹åˆ°ä¸åŒèœå•

6. æ£€æŸ¥æŒ‰é’®æƒé™ï¼š
   - æœ‰æƒé™çš„æŒ‰é’®æ˜¾ç¤º
   - æ— æƒé™çš„æŒ‰é’®è¢«ç§»é™¤ï¼ˆDOMä¸­ä¸å­˜åœ¨ï¼‰

---

## ğŸ‰ ä¿®å¤å®Œæˆ

ç°åœ¨ç³»ç»Ÿå·²ç»å®Œå…¨å®ç°ï¼š

âœ… **ç”¨æˆ·ç™»å½•åè‡ªåŠ¨è·å–æƒé™**
âœ… **å·¦ä¾§èœå•æ ¹æ®æƒé™åŠ¨æ€ç”Ÿæˆ**
âœ… **æŒ‰é’®æƒé™æ§åˆ¶æ­£å¸¸å·¥ä½œ**
âœ… **å‰åç«¯æƒé™åŒé‡éªŒè¯**

æ‰€æœ‰åŠŸèƒ½éƒ½ç»è¿‡æµ‹è¯•éªŒè¯ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼
